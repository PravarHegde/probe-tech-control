import{_ as p}from"./WebcamNozzleCrosshair-B8sRmZuR.js";import{m as d,B as u,a as g,c as f,P as h,R as S,W as m,C as _,n as y}from"./index-CWrpshtP.js";import{m as v,n as C,r as w}from"./vuetify-CGRNWlIO.js";import"./overlayscrollbars-CiKU261J.js";import"./echarts-Ce9dz-GT.js";import"./codemirror-Dbba2-Wz.js";var b=Object.defineProperty,T=Object.getOwnPropertyDescriptor,n=(l,t,e,a)=>{for(var s=a>1?void 0:a?T(t,e):t,o=l.length-1,c;o>=0;o--)(c=l[o])&&(s=(a?c(t,e,s):c(s))||s);return a&&s&&b(t,e,s),s};let i=class extends d(u,g){constructor(){super(...arguments),this.capitalize=f,this.pc=null,this.useStun=!0,this.aspectRatio=null,this.status="connecting",this.restartTimer=null}get url(){var t;return this.convertUrl((t=this.camSettings)==null?void 0:t.stream_url,this.printerUrl)}get wrapperStyle(){return this.getWrapperStyle(this.aspectRatio,this.camSettings.rotation)}get webcamStyle(){var t,e,a,s;return{transform:this.generateTransform((t=this.camSettings.flip_horizontal)!=null?t:!1,(e=this.camSettings.flip_vertical)!=null?e:!1,(a=this.camSettings.rotation)!=null?a:0,(s=this.aspectRatio)!=null?s:1)}}get nozzleCrosshair(){var t,e;return(e=(t=this.camSettings.extra_data)==null?void 0:t.nozzleCrosshair)!=null?e:!1}get expanded(){var t;return this.page!=="dashboard"?!0:(t=this.$store.getters["gui/getPanelExpand"]("webcam-panel",this.viewport))!=null?t:!1}expandChanged(t){if(!t){this.terminate();return}this.start()}async start(){if(this.restartTimer&&(this.log("Clearing restart timer before starting stream"),window.clearTimeout(this.restartTimer)),!this.expanded){this.log("Not expanded, not starting stream");return}this.log("Requesting ICE servers from ".concat(this.url));try{const t=this.useStun?[{urls:["stun:stun.l.google.com:19302"]}]:null,e=await fetch(this.url,{body:JSON.stringify({type:"request",iceServers:t,keepAlive:!0}),method:"POST"});if(this.useStun&&e.status===500){const s=await e.text();this.log("Server returned 500 error, likely due to unsupported ICE server request."),this.log("Serer error message: ".concat(s)),this.useStun=!1,this.restartStream();return}if(e.status!==200){this.log("Failed to start stream: ".concat(e.status)),this.restartStream();return}const a=await e.json();await this.onIceServers(a)}catch(t){this.log("Failed to start stream",t)}}async onIceServers(t){var o,c;this.pc&&this.pc.close();let e={iceServers:(o=t.iceServers)!=null?o:[],sdpSemantics:"unified-plan"};this.pc=new RTCPeerConnection(e),this.pc.addTransceiver("video",{direction:"recvonly"}),"iceServers"in t?this.pc.onicecandidate=r=>this.onIceCandidate(r,t.id):this.log("No ICE servers returned, so the current camera-streamer version may not support them"),this.pc.onconnectionstatechange=()=>this.onConnectionStateChange(),this.pc.ontrack=r=>this.onTrack(r),this.pc.ondatachannel=r=>this.onDataChannel(r),await((c=this.pc)==null?void 0:c.setRemoteDescription(t));const a=await this.pc.createAnswer();await this.pc.setLocalDescription(a);const s=this.pc.localDescription;if(!s){this.log("Failed to create offer"),this.restartStream();return}try{const r=await fetch(this.url,{body:JSON.stringify({type:s==null?void 0:s.type,id:t.id,sdp:s==null?void 0:s.sdp}),headers:{"Content-Type":"application/json"},method:"POST"});r.status!==200&&(this.log("Failed to send offer: ".concat(r.status)),this.restartStream())}catch(r){this.log("Failed to send offer",r),this.restartStream()}}async onIceCandidate(t,e){if(t.candidate)try{const a=await fetch(this.url,{body:JSON.stringify({id:e,type:"remote_candidate",candidates:[t.candidate]}),headers:{"Content-Type":"application/json"},method:"POST"});a.status!==200&&(this.log("Failed to send ICE candidate: ".concat(a.status)),this.restartStream())}catch(a){this.log("Failed to send ICE candidate",a),this.restartStream()}}onConnectionStateChange(){var t,e;this.status=(e=(t=this.pc)==null?void 0:t.connectionState)!=null?e:"connecting",this.log("State: ".concat(this.status)),["failed","disconnected"].includes(this.status)&&this.restartStream(5e3)}onTrack(t){t.track.kind==="video"&&(this.stream.srcObject=t.streams[0])}onDataChannel(t){const e=t.channel;if(this.log("Data channel opened: ".concat(e.label)),e.label!=="keepalive"){this.log("Unknown data channel label: ".concat(e.label));return}e.onmessage=a=>{a.data==="ping"&&e.send("pong")}}log(t,e){}beforeDestroy(){this.terminate(),this.restartTimer&&window.clearTimeout(this.restartTimer)}terminate(){var t;this.log("Terminating stream"),(t=this.pc)==null||t.close()}restartStream(t=500){this.terminate(),!this.restartTimer&&(this.restartTimer=window.setTimeout(async()=>{this.restartTimer=null,await this.start()},t))}onLoadedMetadata(){this.aspectRatio=this.updateAspectRatioFromVideo(this.stream)}changedUrl(){this.restartStream()}};n([h({required:!0})],i.prototype,"camSettings",2);n([h({default:null})],i.prototype,"printerUrl",2);n([h({type:String,default:null})],i.prototype,"page",2);n([S()],i.prototype,"stream",2);n([m("expanded",{immediate:!0})],i.prototype,"expandChanged",1);n([m("url")],i.prototype,"changedUrl",1);i=n([_({components:{WebcamNozzleCrosshair:p}})],i);var x=function(){var t=this,e=t._self._c;return t._self._setupProxy,e("div",{staticClass:"webcamBackground",style:t.wrapperStyle},[e("video",{directives:[{name:"show",rawName:"v-show",value:t.status==="connected",expression:"status === 'connected'"}],ref:"stream",staticClass:"webcamImage",style:t.webcamStyle,attrs:{autoplay:"",muted:"",playsinline:""},domProps:{muted:!0},on:{loadedmetadata:t.onLoadedMetadata}}),t.nozzleCrosshair?e(p,{attrs:{webcam:t.camSettings}}):t._e(),t.status!=="connected"?e(v,[e(C,{staticClass:"_webcam_webrtc_output text-center d-flex flex-column justify-center align-center"},[t.status==="connecting"?e(w,{staticClass:"mb-3",attrs:{indeterminate:"",color:"primary"}}):t._e(),e("span",{staticClass:"mt-3"},[t._v(t._s(t.capitalize(t.status)))])],1)],1):t._e()],1)},z=[],P=y(i,x,z,!1,null,"90cb4f6e");const N=P.exports;export{N as default};
